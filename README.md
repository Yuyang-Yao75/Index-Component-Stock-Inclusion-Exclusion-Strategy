# 指数成分股调入调出预测及策略回测
[![EN](https://img.shields.io/badge/lang-English-blue.svg)](./README.en.md)  
[![CN](https://img.shields.io/badge/lang-中文-red.svg)](./README.md)

> **许可（License）**  
> 本仓库代码以 **PolyForm Noncommercial License 1.0.0** 发布，仅允许非商业用途（学习、研究、评估）。  
> **任何商业使用均需取得单独授权**。商业授权请联系：yyyao75@163.com  
> 详见 [LICENSE](./LICENSE) 与 [COMMERCIAL.md](./COMMERCIAL.md) 文件。
---
## 📘 项目简介
本仓库围绕指数成分股的**调入调出预测**及**调整策略回测**展开，旨在帮助研究者或投资者理解和验证指数编制规则的量化实现以及成分股调整对策略表现的影响。核心功能包括：

- 基于中证指数编制规则对沪深300成分股进行预测；
- 参考国元证券《哈雷之约：基于指数成分股调整的选股策略》进行策略构建，对调仓策略进行回测、参数优化及权重分配研究；
- 提供详尽的数据处理流程与回测结果。

## ✨ 功能特点

### 1) **自动化数据获取与缓存**

* 封装 **iFinDPy** 接口，实现 **沪深300** 与 **全 A 股** 的批量数据抓取。
* 自动进行缺失值填补与一致性校验。
* 将结果缓存为 **Excel**，避免重复请求，加快迭代研究效率。

### 2) **严谨的样本构建与筛选**

* 提供与指数编制规则一致的样本空间构建：

  * 剔除 **ST/＊ST** 股票；
  * 按 **上市时间** 与 **停牌天数** 过滤；
  * 基于 **市值** 与 **成交额** 打分；
  * 按 **流动性分位（50%–60%）** 筛选可交易股票。

### 3) **沪深300 缓冲区与成分股入选逻辑复现**

* 按照中证指数公司规则，区分 **新股与存量股**。
* 设置 **240/360 名次缓冲区**，并结合 **优先纳入/优先剔除** 标签。
* 动态维护 **300 只成分股**，真实还原指数调入调出的细节。

### 4) **预测结果评估与导出**

* 自动与 **官方调入调出表** 对比。
* 统计 **命中率** 并输出 **差异说明** 至 Excel。
* 支持 **批量复盘** 与 **精度分析**。

### 5) **事件驱动回测引擎**

* 可自定义 **公告日 N / 生效日 M** 的相对交易日参数。
* 支持 **等权、总市值、流通市值** 三种建仓方式。
* 逐日记录净值并计算：**收益率、最大回撤、夏普比率、卡玛比率** 等绩效指标。

### 6) **参数优化与可视化**

* 内置 **网格搜索**，自动生成 **热力图、箱线图、敏感性曲线**。
* 帮助快速找到最优的买卖时点与权重组合。

### 7) **一键生成权重方案**

* 独立脚本支持 **等权、总市值、流通市值** 三种权重计算。
* 输出包含 **建议手数** 的交易指引，可直接用于实盘或模拟盘执行。


## 📂 目录结构
```aiignore
│  README.md
│  000300_Index_Methodology_cn.pdf
│  20221212-国元证券-哈雷之约：基于指数成分股调整的选股策略.pdf
│
├─指数成分股调入调出预测
│      沪深300成分股预测.py
│      a_stock_20211031.xlsx
│      a_stock_20220430.xlsx
│      ...
│      hs300_20211031.xlsx
│      hs300_20220430.xlsx
│      ...
│      download_stock_data20211031.csv
│      download_stock_data20220430.csv
│      ...
│      a_stock_20211031处理数据.xlsx
│      a_stock_20220430处理数据.xlsx
│      ...
│      预测结果_2021_12.xlsx
│      预测结果_2022_06.xlsx
│      ...
└─指数成分股调整策略回测
    │  指数成分股调整策略回测.py
    │  000300.SH_backtest_201406-202412_N1_M-4_A_float_cap.xlsx
    │  000300.SH_backtest_201406-202412_N1_M-4_equal.xlsx
    │  000300.SH_backtest_201406-202412_N1_M-4_market_cap.xlsx
    │      ...
    │  000300.SH_strategy_vs_index_201406-202412_N1_M-4_A_float_cap.png
    │  000300.SH_strategy_vs_index_201406-202412_N1_M-4_equal.png
    │  000300.SH_strategy_vs_index_201406-202412_N1_M-4_market_cap.png
    │      ...
    │  000300.SH_merged_details_201406-202412_N1_M-4.xlsx
    │  000300.SH成分股市值_201406-202412.xlsx
    │  000300.SH成分股股票开盘价_201406-202412.xlsx
    │  000300.SH指数开盘价_201406-202412.xlsx
    │  000300.SH调入调出_201406-202412.xlsx
    │      ...
    ├─购入权重预测
    │        000300.SH调入调出最新.xlsx
    │        成分股权重计算.py
    │        成分股权重计算结果_20250530.xlsx
    │        
    └─参数优化研究结果
            参数优化结果汇总.xlsx
            参数敏感性分析.png
            权重方法比较_箱线图.png
            热力图_A_float_cap_年化收益率.png
            热力图_equal_年化收益率.png
            热力图_market_cap_年化收益率.png
```

## 📑 核心文件说明
### 主目录
- **README.md**：项目说明文档。  

### 子目录 1：指数成分股调入调出预测
包含主要预测代码及输入输出数据；通过量化指数编制规则并进行筛选、标签、数据处理等操作生成预测结果，可进一步考虑使用机器学习分类器提升准确度
关键脚本：`沪深300成分股预测.py`。

### 子目录 2：指数成分股调整策略回测
提供策略回测、参数优化及买入权重计算三大功能，支持自动下载所需数据文件并输出回测结果、热力图、敏感性分析等  
关键脚本：`指数成分股调整策略回测.py`。

## 🚀 快速开始
1. **准备数据**：确保上述 Excel/CSV 文件已按目录结构放置；部分历史成分股数据需手动从 iFind 下载。  
2. **运行预测脚本**  
   ```bash
   python 指数成分股调入调出预测/沪深300成分股预测.py
   ```
    根据提示输入目标年份与月份，脚本会自动生成处理后的数据及预测结果。
3. **运行回测脚本**：
    ```bash
    python 指数成分股调整策略回测/指数成分股调整策略回测.py
    ```
    在脚本中配置指数代码、回测区间、买卖时点 M/N 及权重方式；选择需要的功能并注释掉其他功能。

## 📊 结果输出
- 预测模块：生成处理后的 A 股数据表及预测结果对比表。
- 回测模块：输出回测结果表、策略与指数表现对比图、参数优化热力图与敏感性分析图等。

## 🙌 致谢与引用
如果您在研究中使用了本项目，请按照 CITATION.cff 中的格式引用。欢迎在 issue 中提出建议或在 fork 基础上改进后提交 PR。此外，部分文件及代码在本文中提到但为上传至github，如有需要可根据上述邮箱联系我，说明需求后会即时回复。

>声明：本项目目前处于阶段性完成状态，短期内暂不更新。坦率地说，我深知代码在结构设计、运行效率以及复杂度控制等方面还存在诸多不足。若您在阅读和使用过程中发现问题，欢迎毫不保留地批评与指正。我始终相信，真诚的交流与分享是彼此进步的起点，也是这份工作的最大意义所在。
