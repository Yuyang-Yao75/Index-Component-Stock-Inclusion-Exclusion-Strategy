## 文件夹结构
```aiignore
│  README.md
│  沪深300历史调入调出股票k线图数据-手动回测.xlsx
│  沪深A股20241031(完整数据)-手动预测.xlsx
│  预测不准确原因梳理-基于回测.xlsx
│  预测对比-各券商.xlsx
│
├─指数成分股调入调出预测
│      沪深300成分股预测.py
│      a_stock_20211031.xlsx
│      a_stock_20220430.xlsx
│      ...
│      hs300_20211031.xlsx
│      hs300_20220430.xlsx
│      ...
│      download_stock_data20211031.csv
│      download_stock_data20220430.csv
│      ...
│      a_stock_20211031处理数据.xlsx
│      a_stock_20220430处理数据.xlsx
│      ...
│      预测结果_2021_12.xlsx
│      预测结果_2022_06.xlsx
│      ...
└─指数成分股调整策略回测
    │  指数成分股调整策略回测.py
    │  000300.SH_backtest_201406-202412_N1_M-4_A_float_cap.xlsx
    │  000300.SH_backtest_201406-202412_N1_M-4_equal.xlsx
    │  000300.SH_backtest_201406-202412_N1_M-4_market_cap.xlsx
    │      ...
    │  000300.SH_strategy_vs_index_201406-202412_N1_M-4_A_float_cap.png
    │  000300.SH_strategy_vs_index_201406-202412_N1_M-4_equal.png
    │  000300.SH_strategy_vs_index_201406-202412_N1_M-4_market_cap.png
    │      ...
    │  000300.SH_merged_details_201406-202412_N1_M-4.xlsx
    │  000300.SH成分股市值_201406-202412.xlsx
    │  000300.SH成分股股票开盘价_201406-202412.xlsx
    │  000300.SH指数开盘价_201406-202412.xlsx
    │  000300.SH调入调出_201406-202412.xlsx
    │      ...
    ├─购入权重预测
    │        000300.SH调入调出最新.xlsx
    │        成分股权重计算.py
    │        成分股权重计算结果_20250530.xlsx
    │        
    └─参数优化研究结果
            参数优化结果汇总.xlsx
            参数敏感性分析.png
            权重方法比较_箱线图.png
            热力图_A_float_cap_年化收益率.png
            热力图_equal_年化收益率.png
            热力图_market_cap_年化收益率.png
```
## 各文件内容
### 主文件夹
1. <span style="color:red">README.md</span>：说明性文档
2. <span style="color:red">沪深300历史调入调出股票k线图数据-手动回测.xlsx</span>：手动操作对指数成分股调入策略进行回测，采用开盘价回测，加权方式为市值加权（执行日当天市值，利用未来信息，存在一些问题），回测期为公告日当天开盘（此时无法知晓实际调入股票）至公告期最后一个交易日（执行日前一个交易日如2025年6月13日）。
3. <span style="color:red">沪深A股20241031(完整数据)-手动预测.xlsx</span>：手动操作对沪深300成分股进行预测，规则参考中证指数公司公布的指数制定规则中可量化的板块。
4. <span style="color:red">预测不准确原因梳理-基于回测.xlsx</span>：基于回测结果对预测中存在偏差的部分进行了人工归因。

### 子文件夹1：指数成分股调入调出预测
    该文件价包含了指数成分股调入调出预测的主代码及输入输出数据，调入调出预测中量化了中证公司发布的指数编制规则中可量化的部分，但实际情况存在一些主管判断的部分（详细可见"<span style="color:red">预测不准确原因梳理-基于回测.xlsx</span>"中的异常部分），因此导致误差出现。可改进的方向是利用机器学习中的分类器进行分类。

- <span style="color:red">沪深300成分股预测.py</span>：本代码本质上是在不断地对"沪深A股名单及相关数据"进行增删改
  - 输入：目标预测的年份和月份。
  - 功能描述：
    - 首先根据输入及指数编制规则获取目标数据区间（如2025年6月批次参考2024年5月1日至2025年4月30日的交易数据）。
    - 而后读取三份文件
      1. <span style="color:red">沪深300(000300.SH)-历史成分股.xlsx</span>：此文件需要手动在iFind中下载，仅用于预测回测时核对回测结果，在公布前运行代码可无视该文件，在公布后运行代码需要更新该表格；
      2. 沪深300成分股：用于比对新老股，如<span style="color:red">hs300_20211031.xlsx</span>，代码能够实现自动判断是否已经下载该文件，若已下载会避免重复下载；
      3. 沪深A股名单及相关数据：用于筛选新一批沪深300成分股，如<span style="color:red">a_stock_20211031.xlsx</span>。
    - 数据预处理：首先通过人工计算填补缺失值并对原始计算数据进行保存，如<span style="color:red">download_stock_data20211031.csv</span>；其次对新老股进行标签。
    - 构建样本空间：移除ST和*ST股；移除科创板上市不满一年股票；移除主板上市不满一季度股票；移除连续停牌股票。
    - 数据筛选：移除低流动性股票；更新市值（采用A股流通市值计算日均总市值，iFind上下载的日均总市值包括了ABH股。）；根据筛选标准筛选出目标指数。
  - 输出：两份文档
    1. 沪深A股名单及相关数据处理文档，如<span style="color:red">a_stock_20211031处理数据.xlsx</span>。
    2. 预测结果文档，包含两个子表，第一个子表为模型预测结果并与实际情况进行比对（如果对未来进行预测则对比列均为"不正确"），第二个子表为实际情况并于模型预测结果进行比对（如果对未来进行预测则此表为空）。
  - 注意：
    1. 指数编制规则可以在中证指数官网下载

### 子文件夹2：指数成分股调整策略回测
- <span style="color:red">指数成分股调整策略回测.py</span>：
  - 输入：
    - 指数代码、回测起始年月和结束年月（均可人工设置）
    - <span style="color:red">000300.SH成分股市值_201406-202412.xlsx</span>、<span style="color:red">000300.SH成分股股票开盘价_201406-202412.xlsx</span> 、<span style="color:red">000300.SH指数开盘价_201406-202412.xlsx</span> 、<span style="color:red">000300.SH调入调出_201406-202412.xlsx</span>四份文件为原始数据，代码能够实现自动下载及保存（不存在重复下载）。
  - 三大功能：
    1. 功能1：根据设置好的买卖时点（M、N，人工设置）+权重分配方式（三种权重，人工设置）对策略进行回测（开盘价回测）
       - 输出：一表一图，包含了完整的回测结果，如<span style="color:red">000300.SH_backtest_201406-202412_N1_M-4_A_float_cap.xlsx</span>、<span style="color:red">000300.SH_strategy_vs_index_201406-202412_N1_M-4_A_float_cap.png</span>
    2. 功能2：参数优化研究，对买卖回测时点和权重进行参数优化，找到最优参数（无需设置参数）。
       - 输出：同功能1输出（三个参数共生成6*6*3=108种情况）+一个文件夹"参数优化研究结果"（包含不同权重分配的热力图，权重方法比较的箱线图，汇总策略整体评价指标的参数优化结果汇总表，参数敏感性分析图）
    3. 功能3：根据设置好的本金（在回测函数中进行修改）计算每期每只股票的实际买入金额及手数（M、N人工设置）。
       - 输出：每一期不同权重下实际买入金额及手术，一个子表代表一期，如<span style="color:red">000300.SH_merged_details_201406-202412_N1_M-4.xlsx</span>。
  - 注意：
    1. 在使用上述三项其中一个功能的时候将另外两个注释掉。